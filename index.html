<!DOCTYPE html>
<html>
	<head>
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://tacobandit744.github.io">
		<meta property="og:title" content="Milk Radio | Hosted on Github">
		<meta property="og:description" content="Music. ATHF. What more do you need?">
		<meta property="og:image" content="/images/og_512x512.png">
		<title>Welcome to my internet radio!!!</title>
		<!-- bootstrap 5 CSS -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
		<!-- bootstrap 5 JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
		<!-- JQuery -->
		<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"  integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
	</head>
	<body>
		<div id="radio"class="container"></div>
	</body>
</html>

<script>
	let activeStreams = [];
	$(document).ready(function() {
		getIcecastMetadata(false);
	});

	function getIcecastMetadata(hasStarted) {
		fetch("https://milkradioandthings.us/status-json.xsl", {
	      method: "GET"
		})
		.then( (response) => response.json())
		.then( (json) => {
			if (!hasStarted) initRadio(json['icestats']['source']);
			else maintainRadio(json['icestats']['source']);
		});
	}

	function initRadio (radiodata) {
		if (radiodata) {
			radiodata.forEach( (stream) => {
				console.log(stream);
				activeStreams.push(stream.server_name);
				// since it's new, build a new div object to house it and append it to the radio div
				$('#radio').append(addNewRadioSection(stream));
			});
			setInterval(getIcecastMetadata(true), 5000);
		}
	}

	function fixMyURL(url) {
		url = url.replace("http", "https");
		url = url.replace(":8000", "");
		return url;
	}

	function addNewRadioSection(stream) {
		return `
			<div class="card" id="${stream.server_name}">
				<div class="form-group col">
					<div class="col artist-title">${stream.artist} - ${stream.title}</div>
					<div class="col">
						<audio controls src="${fixMyURL(stream.listenurl)}" type="${stream.server_type}">
					</div>
				</div>		
			</div>			
			`;
	}

	function maintainRadio(radiodata) {
		if (radiodata) {
			let currRadioData = [];
			radiodata.forEach( (stream) => {
				currRadioData.push(stream.server_name);
				// update existing stream data
				if (activeStreams[stream.server_name] != null) {
					$(`#${server_name}`).children('.artist-title').html(`${stream.artist} - ${stream.title}`);
				}
				// add new radio if not in activeStreams
				else {
					$('#radio').append(addNewRadioSection(stream));
				}
			});
			// remove dead streams
			const deadStreams = activeStreams.filter(x => radiodata['server_name'] != x);
			console.log(deadStreams);
			deadStreams.forEach(x => $(`#radio #${x}`).remove());
		}
	}
</script>